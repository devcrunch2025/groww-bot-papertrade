<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Strategy Comparison</title>
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        font-size: 12px;
        background: #f5f7fb;
        color: #1f2937;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 10px;
      }
      .card {
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 8px;
      }
      h1 {
        margin: 0 0 8px 0;
        font-size: 18px;
      }
      .row {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }
      .kpi-grid {
        display: grid;
        grid-template-columns: repeat(5, minmax(120px, 1fr));
        gap: 8px;
      }
      .kpi-card {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 8px;
        background: #ffffff;
      }
      .kpi-label {
        color: #6b7280;
        font-size: 11px;
        margin-bottom: 2px;
      }
      .kpi-value {
        font-size: 14px;
        font-weight: 700;
      }
      input[type="date"] {
        border: 1px solid #d1d5db;
        border-radius: 6px;
        padding: 4px 6px;
        font-size: 12px;
      }
      button {
        border: none;
        background: #2563eb;
        color: white;
        padding: 5px 8px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
        padding: 6px;
        font-size: 12px;
      }
      .pos {
        color: #166534;
      }
      .neg {
        color: #991b1b;
      }
      .neu {
        color: #1f2937;
      }
      .best-row td {
        background: #eff6ff;
        font-weight: bold;
      }
      .muted {
        color: #6b7280;
        font-size: 11px;
      }
      .trend-wrap {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 8px;
        background: #ffffff;
      }
      .trend-title {
        margin: 0 0 6px 0;
        font-size: 13px;
      }
      #winnerTrendCanvas {
        width: 100%;
        height: 180px;
        display: block;
      }
      .trend-log {
        max-height: 130px;
        overflow: auto;
        margin-top: 6px;
      }
      .strategy-block {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 8px;
        margin-bottom: 8px;
      }
      .strategy-title {
        margin: 0 0 6px 0;
        font-size: 13px;
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }
      .badge {
        display: inline-block;
        border: 1px solid #d1d5db;
        border-radius: 999px;
        padding: 2px 7px;
        font-size: 10px;
        color: #374151;
        background: #f9fafb;
      }
      .table-wrap {
        max-height: 320px;
        overflow: auto;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
      }
      .table-wrap table th {
        position: sticky;
        top: 0;
        background: #ffffff;
        z-index: 1;
      }
      .small-muted {
        color: #6b7280;
        font-size: 10px;
      }
      .split {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }
      @media (max-width: 900px) {
        .kpi-grid {
          grid-template-columns: repeat(2, minmax(120px, 1fr));
        }
        .split {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <h1>Strategy Comparison</h1>
        <div class="row">
          <label for="compareDate">Date</label>
          <input type="date" id="compareDate" />
          <button id="loadComparisonBtn">Load Comparison</button>
          <button id="toggleAutoRefreshBtn">Auto Refresh: On</button>
          <span id="refreshInfo" class="muted">Next refresh in: 15s</span>
          <span id="summaryInfo" class="muted">Loading...</span>
        </div>
      </div>

      <div class="card">
        <div id="kpiGrid" class="kpi-grid"></div>
      </div>

      <div class="card">
        <table>
          <thead>
            <tr>
              <th>Rank</th>
              <th>Strategy</th>
              <th>Total Trades</th>
              <th>Realized P&L</th>
              <th>Unrealized P&L</th>
              <th>Total P&L</th>
              <th>P&L %</th>
            </tr>
          </thead>
          <tbody id="comparisonTable"></tbody>
        </table>
      </div>

      <div class="card">
        <div class="trend-wrap">
          <h2 class="trend-title">Winner Trend (Best Strategy P/L Over Time)</h2>
          <canvas id="winnerTrendCanvas" width="1120" height="180"></canvas>
          <div class="trend-log">
            <table>
              <thead>
                <tr>
                  <th>Time</th>
                  <th>Best Strategy</th>
                  <th>Total P/L</th>
                </tr>
              </thead>
              <tbody id="winnerTrendLog"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="card">
        <h1 style="font-size:16px; margin-bottom:6px;">Strategy-wise Live Trades & History</h1>
        <div id="strategyDetails"></div>
      </div>
    </div>

    <script>
      const REFRESH_MS = 15000;
      let autoRefreshEnabled = true;
      let refreshTimerId = null;
      let countdownTimerId = null;
      let nextRefreshAt = Date.now() + REFRESH_MS;
      let trendSeries = [];
      let trendDate = null;

      function todayDateValue() {
        return new Date().toISOString().slice(0, 10);
      }

      function toNumber(value) {
        const parsed = Number(value);
        return Number.isFinite(parsed) ? parsed : 0;
      }

      function valueClass(value) {
        if (value > 0) return 'pos';
        if (value < 0) return 'neg';
        return 'neu';
      }

      function formatAmount(value) {
        return toNumber(value).toFixed(2);
      }

      function formatPercent(value) {
        const numericValue = toNumber(value);
        const prefix = numericValue > 0 ? '+' : '';
        return `${prefix}${numericValue.toFixed(2)}%`;
      }

      function formatCountdown(ms) {
        const totalSec = Math.max(0, Math.ceil(ms / 1000));
        return `${totalSec}s`;
      }

      function renderRefreshInfo() {
        const refreshInfo = document.getElementById('refreshInfo');
        if (!refreshInfo) return;

        if (!autoRefreshEnabled) {
          refreshInfo.textContent = 'Auto refresh paused';
          return;
        }

        refreshInfo.textContent = `Next refresh in: ${formatCountdown(nextRefreshAt - Date.now())}`;
      }

      function renderKpis(data) {
        const kpiGrid = document.getElementById('kpiGrid');
        if (!kpiGrid) return;

        const rows = data?.results || [];
        const best = rows.find((row) => row.strategyId === data?.bestStrategyId) || rows[0] || null;
        const totalStrategies = rows.length;
        const totalTrades = rows.reduce((sum, row) => sum + toNumber(row.totalTrades), 0);
        const combinedPnl = rows.reduce((sum, row) => sum + toNumber(row.totalPnl), 0);
        const avgPnl = totalStrategies > 0 ? combinedPnl / totalStrategies : 0;
        const spreadPnl = rows.length > 1
          ? toNumber(rows[0].totalPnl) - toNumber(rows[rows.length - 1].totalPnl)
          : 0;

        const items = [
          { label: 'Best Strategy', value: best ? `${best.strategyId} (${formatAmount(best.totalPnl)})` : '-' },
          { label: 'Strategies', value: String(totalStrategies) },
          { label: 'Total Trades', value: String(totalTrades) },
          { label: 'Combined P/L', value: formatAmount(combinedPnl), cls: valueClass(combinedPnl) },
          { label: 'Avg P/L | Spread', value: `${formatAmount(avgPnl)} | ${formatAmount(spreadPnl)}` },
        ];

        kpiGrid.innerHTML = items
          .map((item) => `
            <div class="kpi-card">
              <div class="kpi-label">${item.label}</div>
              <div class="kpi-value ${item.cls || ''}">${item.value}</div>
            </div>
          `)
          .join('');
      }

      function pushWinnerTrend(data) {
        const rows = data?.results || [];
        const bestId = data?.bestStrategyId || rows[0]?.strategyId || '-';
        const bestRow = rows.find((row) => row.strategyId === bestId) || rows[0] || null;
        const bestPnl = bestRow ? toNumber(bestRow.totalPnl) : 0;
        const pointTime = data?.lastUpdated ? new Date(data.lastUpdated) : new Date();

        if (trendDate !== data?.date) {
          trendDate = data?.date || null;
          trendSeries = [];
        }

        trendSeries.push({
          time: pointTime,
          strategyId: bestId,
          totalPnl: bestPnl,
        });

        if (trendSeries.length > 100) {
          trendSeries = trendSeries.slice(-100);
        }
      }

      function drawWinnerTrend() {
        const canvas = document.getElementById('winnerTrendCanvas');
        if (!canvas) return;

        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;
        ctx.clearRect(0, 0, width, height);

        const padding = { left: 42, right: 12, top: 10, bottom: 28 };
        const chartWidth = width - padding.left - padding.right;
        const chartHeight = height - padding.top - padding.bottom;

        ctx.strokeStyle = '#e5e7eb';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(padding.left, padding.top + chartHeight);
        ctx.lineTo(width - padding.right, padding.top + chartHeight);
        ctx.stroke();

        if (trendSeries.length === 0) {
          ctx.fillStyle = '#6b7280';
          ctx.font = '12px Arial';
          ctx.fillText('No trend data yet', padding.left, padding.top + 16);
          return;
        }

        const pnlValues = trendSeries.map((item) => toNumber(item.totalPnl));
        let minPnl = Math.min(...pnlValues);
        let maxPnl = Math.max(...pnlValues);
        if (minPnl === maxPnl) {
          minPnl -= 1;
          maxPnl += 1;
        }

        const toX = (index) => padding.left + (index / Math.max(1, trendSeries.length - 1)) * chartWidth;
        const toY = (value) => {
          const ratio = (toNumber(value) - minPnl) / (maxPnl - minPnl);
          return padding.top + chartHeight - (ratio * chartHeight);
        };

        ctx.strokeStyle = '#2563eb';
        ctx.lineWidth = 2;
        ctx.beginPath();
        trendSeries.forEach((item, index) => {
          const x = toX(index);
          const y = toY(item.totalPnl);
          if (index === 0) {
            ctx.moveTo(x, y);
          } else {
            ctx.lineTo(x, y);
          }
        });
        ctx.stroke();

        const last = trendSeries[trendSeries.length - 1];
        const lx = toX(trendSeries.length - 1);
        const ly = toY(last.totalPnl);
        ctx.fillStyle = '#2563eb';
        ctx.beginPath();
        ctx.arc(lx, ly, 3, 0, Math.PI * 2);
        ctx.fill();

        ctx.fillStyle = '#1f2937';
        ctx.font = '11px Arial';
        ctx.fillText(`Min ${formatAmount(minPnl)}`, 4, padding.top + chartHeight - 2);
        ctx.fillText(`Max ${formatAmount(maxPnl)}`, 4, padding.top + 10);
        ctx.fillText(`Now ${last.strategyId}: ${formatAmount(last.totalPnl)}`, padding.left, height - 8);
      }

      function renderWinnerTrendLog() {
        const body = document.getElementById('winnerTrendLog');
        if (!body) return;

        body.innerHTML = trendSeries
          .slice(-20)
          .reverse()
          .map((point) => `
            <tr>
              <td>${point.time ? new Date(point.time).toLocaleTimeString() : '-'}</td>
              <td>${point.strategyId || '-'}</td>
              <td class="${valueClass(point.totalPnl)}">${formatAmount(point.totalPnl)}</td>
            </tr>
          `)
          .join('');
      }

      async function fetchComparison(date) {
        const selectedDate = String(date || '').trim();
        const isTodayMode = selectedDate === '' || selectedDate === todayDateValue();
        const query = isTodayMode
          ? `?_ts=${Date.now()}`
          : `?date=${encodeURIComponent(selectedDate)}&_ts=${Date.now()}`;
        const response = await fetch(`/api/strategy-monitor${query}`, {
          cache: 'no-store',
          headers: {
            'Cache-Control': 'no-cache',
            Pragma: 'no-cache',
          },
        });

        if (!response.ok) {
          throw new Error(`Comparison request failed: ${response.status}`);
        }

        return response.json();
      }

      function renderComparison(data) {
        const body = document.getElementById('comparisonTable');
        const summaryInfo = document.getElementById('summaryInfo');
        const strategyDetails = document.getElementById('strategyDetails');
        const rows = data?.results || [];

        renderKpis(data);

        body.innerHTML = rows
          .map((row, index) => {
            const rowClass = row.strategyId === data.bestStrategyId ? 'best-row' : '';
            const sourceLabel = String(row.dataSource || 'simulation').toUpperCase();

            return `
              <tr class="${rowClass}">
                <td>${index + 1}</td>
                <td>${row.strategyId} - ${row.strategyName}</td>
                <td>${row.totalTrades}</td>
                <td class="${valueClass(row.realizedPnl)}">${formatAmount(row.realizedPnl)}</td>
                <td class="${valueClass(row.unrealizedPnl)}">${formatAmount(row.unrealizedPnl)}</td>
                <td class="${valueClass(row.totalPnl)}">${formatAmount(row.totalPnl)}</td>
                <td class="${valueClass(row.pnlPercent)}">${formatPercent(row.pnlPercent)}</td>
              </tr>
            `;
          })
          .join('');

        const selectedDate = String(document.getElementById('compareDate')?.value || '').trim();
        const mode = (!selectedDate || selectedDate === todayDateValue()) ? 'LIVE' : 'DATE';
        const tradeCountsText = rows
          .map((row) => `${row.strategyId}:${toNumber(row.totalTrades)}`)
          .join(' | ');
        summaryInfo.textContent = `Mode: ${mode} | Date: ${data.date} | Capital: ${formatAmount(data.capital)} | Active: ${data.activeStrategyId || '-'} | Best: ${data.bestStrategyId || '-'} | Updated: ${data.lastUpdated ? new Date(data.lastUpdated).toLocaleTimeString() : '-'} | Trades ${tradeCountsText}`;

        strategyDetails.innerHTML = rows
          .map((row) => {
            const sourceLabel = String(row.dataSource || 'simulation').toUpperCase();
            const openPositions = row.openPositions || [];
            const recentTrades = row.recentTrades || [];

            const openRows = openPositions.length > 0
              ? openPositions.map((position) => `
                  <tr>
                    <td>${position.symbol}</td>
                    <td>${position.side || '-'}</td>
                    <td>${formatAmount(position.entryPrice)}</td>
                    <td>${position.remainingUnits}</td>
                    <td>${position.entryTime ? new Date(position.entryTime).toLocaleString() : '-'}</td>
                  </tr>
                `).join('')
              : '<tr><td colspan="5" class="muted">No active trades</td></tr>';

            const tradeRows = recentTrades.length > 0
              ? recentTrades.slice(-20).reverse().map((trade) => `
                  <tr>
                    <td>${trade.time ? new Date(trade.time).toLocaleString() : '-'}</td>
                    <td>${trade.action || '-'}</td>
                    <td>${trade.symbol || '-'}</td>
                    <td>${formatAmount(trade.price)}</td>
                    <td>${trade.units ?? '-'}</td>
                    <td>${trade.reason || '-'}</td>
                    <td class="${valueClass(toNumber(trade.pnl))}">${trade.pnl === null || trade.pnl === undefined ? '-' : formatAmount(trade.pnl)}</td>
                  </tr>
                `).join('')
              : '<tr><td colspan="7" class="muted">No trades yet</td></tr>';

            return `
              <div class="strategy-block">
                <h3 class="strategy-title ${valueClass(row.totalPnl)}">
                  <span>${row.strategyId} - ${row.strategyName} | P/L: ${formatAmount(row.totalPnl)} (${formatPercent(row.pnlPercent)})</span>
                  <span class="badge">Source: ${sourceLabel}</span>
                  <span class="small-muted">Trades: ${toNumber(row.totalTrades)} | Realized: ${formatAmount(row.realizedPnl)} | Unrealized: ${formatAmount(row.unrealizedPnl)}</span>
                </h3>
                <div class="split">
                  <div>
                    <div class="table-wrap">
                      <table>
                        <thead>
                          <tr>
                            <th colspan="5">Active Trades</th>
                          </tr>
                          <tr>
                            <th>Symbol</th>
                            <th>Side</th>
                            <th>Entry</th>
                            <th>Units</th>
                            <th>Entry Time</th>
                          </tr>
                        </thead>
                        <tbody>${openRows}</tbody>
                      </table>
                    </div>
                  </div>
                  <div>
                    <div class="table-wrap">
                      <table>
                        <thead>
                          <tr>
                            <th colspan="7">Recent Trade History (last 20)</th>
                          </tr>
                          <tr>
                            <th>Time</th>
                            <th>Action</th>
                            <th>Symbol</th>
                            <th>Price</th>
                            <th>Units</th>
                            <th>Reason</th>
                            <th>P/L</th>
                          </tr>
                        </thead>
                        <tbody>${tradeRows}</tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            `;
          })
          .join('');

        pushWinnerTrend(data);
        drawWinnerTrend();
        renderWinnerTrendLog();
      }

      async function loadComparison() {
        const date = document.getElementById('compareDate').value;
        const summaryInfo = document.getElementById('summaryInfo');

        try {
          summaryInfo.textContent = 'Loading comparison...';
          const data = await fetchComparison(date);
          renderComparison(data);
          nextRefreshAt = Date.now() + REFRESH_MS;
          renderRefreshInfo();
        } catch (error) {
          summaryInfo.textContent = `Comparison error: ${error.message}`;
          document.getElementById('comparisonTable').innerHTML = '';
        }
      }

      function startAutoRefresh() {
        if (refreshTimerId) {
          clearInterval(refreshTimerId);
          refreshTimerId = null;
        }

        if (!autoRefreshEnabled) {
          return;
        }

        refreshTimerId = setInterval(() => {
          loadComparison();
        }, REFRESH_MS);

        nextRefreshAt = Date.now() + REFRESH_MS;
        renderRefreshInfo();
      }

      function startCountdownTimer() {
        if (countdownTimerId) {
          clearInterval(countdownTimerId);
          countdownTimerId = null;
        }

        countdownTimerId = setInterval(() => {
          renderRefreshInfo();
        }, 1000);
      }

      const urlDate = new URLSearchParams(window.location.search).get('date');
      document.getElementById('compareDate').value = urlDate || todayDateValue();
      document.getElementById('loadComparisonBtn').addEventListener('click', loadComparison);
      document.getElementById('toggleAutoRefreshBtn').addEventListener('click', () => {
        autoRefreshEnabled = !autoRefreshEnabled;
        document.getElementById('toggleAutoRefreshBtn').textContent = `Auto Refresh: ${autoRefreshEnabled ? 'On' : 'Off'}`;
        startAutoRefresh();
        renderRefreshInfo();
      });
      loadComparison();
      startAutoRefresh();
      startCountdownTimer();
    </script>
  </body>
</html>
